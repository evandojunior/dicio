#!/usr/bin/env node

'use strict';

const iconv = require('iconv-lite');
const removeAccents = require('remover-acentos');
const request = require('request');

if (!process.argv[2]) {
    console.error('Uso: dicio <palavra>');
    process.exit(0);
}

const word = removeAccents(process.argv[2]).toLowerCase();

request.get({
    'uri': 'https://dicionariodoaurelio.com/' + word,
    'encoding': null
}, (error, response, body) => {
    if (error) {
        console.error('Erro!');
        process.exit(1);
    } else if (response.statusCode === 302) {
        console.error('Palavra não enontrada.');
        process.exit(1);
    } else if (response.statusCode !== 200) {
        console.error('Serviço indisponível.');
        process.exit(1);
    } else {
        body = iconv.decode(new Buffer(body), 'UTF-8')
            .split('<article>')[1]
            .split('</article>')[0]
            .replace(/<h2>Significado\sde\s.*<\/h2>/g, '')
            .replace(/<br>/g, '')
            .trim();

        body = body.replace(/:\s+/gi, ': ');

        if (!body) {
            console.error('Palavra não enontrada.');
            process.exit(1);
        }

        console.log(body);
        process.exit(0);
    }
});
